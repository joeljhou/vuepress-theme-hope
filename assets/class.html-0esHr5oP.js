import{_ as d}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as l,c as i,a,b as t,d as e,e as n}from"./app-Bxm957S7.js";const c={},r=n('<h1 id="类字节码详解" tabindex="-1"><a class="header-anchor" href="#类字节码详解"><span>类字节码详解</span></a></h1><blockquote><p>计算机只能运行由0和1构成的二进制格式。 要运行Java程序，必须先通过Java虚拟机（JVM）执行编译后的Java代码，这个编译后的代码就是<strong>Java字节码</strong>。</p></blockquote><h2 id="跨平台的基石" tabindex="-1"><a class="header-anchor" href="#跨平台的基石"><span>跨平台的基石</span></a></h2><p>Java字节码具有“平台无关性”和“语言无关性”。</p><ul><li><strong>平台无关性：</strong> 字节码可以在任何支持JVM的平台上运行，实现“一次编写，到处运行”</li><li><strong>语言无关性：</strong> 多种编程语言可以编译成字节码并在JVM（GraalVM）上运行，不仅限于Java</li></ul><figure><img src="https://img.geekyspace.cn/pictures/2024/202407200209120.png" alt="Java虚拟机提供的语言无关性" tabindex="0" loading="lazy"><figcaption>Java虚拟机提供的语言无关性</figcaption></figure><h2 id="class类文件结构" tabindex="-1"><a class="header-anchor" href="#class类文件结构"><span>Class类文件结构</span></a></h2><p>Java技术的良好向后兼容性得益于Class文件结构的稳定性， 每个Class文件对应一个类或接口的定义信息，是一组以8个字节为单位的二进制流。各数据项严格按顺序排列，没有任何分隔符。</p><p>Class文件格式类似于C语言的结构体，这种伪结构只有两种数据类型：“无符号数”和“表”。</p><ul><li><strong>无符号数：</strong> 基本数据类型，使用<code>u1</code>、<code>u2</code>、<code>u4</code>、<code>u8</code>表示1、2、4、8个字节的无符号数。 它们可以描述数字、索引引用、数量值或按照<code>UTF-8</code>编码的字符串值。</li><li><strong>表：</strong> 由多个无符号数或其他表构成的复合数据类型，通常以“_info”结尾。 表用于描述有层次关系的复合结构，整个Class文件本质上也是一个表，由按严格顺序排列的数据项构成。</li></ul>',10),p={href:"https://docs.oracle.com/javase/specs/jvms/se22/html/jvms-4.html",target:"_blank",rel:"noopener noreferrer"},u=a("code",null,"ClassFile",-1),m=n(`<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">ClassFile</span> <span class="token punctuation">{</span>
  u4 magic<span class="token punctuation">;</span>                   <span class="token comment">// 魔数 (0xCAFEBABE)，标识class文件格式</span>
  u2 minor_version<span class="token punctuation">;</span>           <span class="token comment">// 次版本号</span>
  u2 major_version<span class="token punctuation">;</span>           <span class="token comment">// 主版本号</span>
  u2 constant_pool_count<span class="token punctuation">;</span>     <span class="token comment">// 常量池计数</span>
  cp_info constant_pool<span class="token punctuation">[</span>constant_pool_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 常量池</span>
  u2 access_flags<span class="token punctuation">;</span>            <span class="token comment">// 访问标志</span>
  u2 this_class<span class="token punctuation">;</span>              <span class="token comment">// 当前类索引</span>
  u2 super_class<span class="token punctuation">;</span>             <span class="token comment">// 父类索引</span>
  u2 interfaces_count<span class="token punctuation">;</span>        <span class="token comment">// 接口计数</span>
  u2 interfaces<span class="token punctuation">[</span>interfaces_count<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 接口索引表</span>
  u2 fields_count<span class="token punctuation">;</span>            <span class="token comment">// 字段计数</span>
  field_info fields<span class="token punctuation">[</span>fields_count<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 字段表</span>
  u2 methods_count<span class="token punctuation">;</span>           <span class="token comment">// 方法计数</span>
  method_info methods<span class="token punctuation">[</span>methods_count<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 方法表</span>
  u2 attributes_count<span class="token punctuation">;</span>        <span class="token comment">// 属性计数</span>
  attribute_info attributes<span class="token punctuation">[</span>attributes_count<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 属性表</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过分析 ClassFile 的内容，我们便可以知道 class 文件的组成。</p><figure><img src="https://img.geekyspace.cn/pictures/2024/202407220149546.png" alt="ClassFile 内容分析" tabindex="0" loading="lazy"><figcaption>ClassFile 内容分析</figcaption></figure><h3 id="魔数" tabindex="-1"><a class="header-anchor" href="#魔数"><span>魔数</span></a></h3><p>魔数是头4个字节的值<code>0xCAFEBABE</code>，用于验证文件是否为有效的Class文件。 不仅限于Class文件，很多文件格式如<code>GIF</code>或<code>JPEG</code>等也使用魔数来进行身份识别。</p><ul><li>GIF文件：<code>47 49 46 38</code></li><li>JPEG文件：<code>FF D8 FF E0</code></li></ul><p>在Java被称为“Oak”语言时期（大约1991年前后），<code>0xCAFEBABE</code>被选为魔数。 Java开发小组关键成员Patrick Naughton提到，他们选择这个值是因为它好玩且容易记忆， 象征着著名咖啡品牌Peet’s Coffee深受欢迎的Baristas咖啡，也预示着日后“Java”这一商标名称的出现。</p><h3 id="class文件版本号" tabindex="-1"><a class="header-anchor" href="#class文件版本号"><span>Class文件版本号</span></a></h3><p>紧跟魔数<code>0xCAFEBABE</code>之后的4个字节存储的是Class文件的版本号，其中：</p><ul><li>第5~6字节：次版本号（Minor Version）</li><li>第7~8字节：主版本号（Major Version），Java 8 = 52.0</li></ul><p>Java的主版本号从JDK 1.0的45开始，每次大版本发布都会+1； 次版本号通常保持为0，对应一些次要的特性改进或修复。</p><p><strong>Java版本对应表：</strong></p><table><thead><tr><th>JDK版本</th><th>十进制</th><th>十六进制</th><th>发布时间</th></tr></thead><tbody><tr><td>JDK1.1</td><td>45</td><td>0x2D</td><td>1996-05-15</td></tr><tr><td>JDK1.2</td><td>46</td><td>0x2E</td><td>1998-12-08</td></tr><tr><td>JDK1.3</td><td>47</td><td>0x2F</td><td>2000-05-08</td></tr><tr><td>JDK1.4</td><td>48</td><td>0x30</td><td>2002-02-13</td></tr><tr><td>JDK1.5</td><td>49</td><td>0x31</td><td>2004-09-30</td></tr><tr><td>JDK1.6</td><td>50</td><td>0x32</td><td>2006-12-11</td></tr><tr><td>JDK1.7</td><td>51</td><td>0x33</td><td>2011-07-28</td></tr><tr><td>JDK1.8</td><td>52</td><td>0x34</td><td>2014-03-18</td></tr><tr><td>Java9</td><td>53</td><td>0x35</td><td>2017-09-21</td></tr><tr><td>Java10</td><td>54</td><td>0x36</td><td>2018-03-20</td></tr><tr><td>Java11</td><td>55</td><td>0x37</td><td>2018-09-25</td></tr><tr><td>Java12</td><td>56</td><td>0x38</td><td>2019-03-19</td></tr><tr><td>Java13</td><td>57</td><td>0x39</td><td>2019-09-17</td></tr><tr><td>Java14</td><td>58</td><td>0x3A</td><td>2020-03-17</td></tr><tr><td>Java15</td><td>59</td><td>0x3B</td><td>2020-09-15</td></tr><tr><td>Java16</td><td>60</td><td>0x3C</td><td>2021-03-16</td></tr><tr><td>Java17</td><td>61</td><td>0x3D</td><td>2021-09-14</td></tr><tr><td>Java18</td><td>62</td><td>0x3E</td><td>2022-03-22</td></tr><tr><td>Java19</td><td>63</td><td>0x3F</td><td>2022-09-20</td></tr><tr><td>Java20</td><td>64</td><td>0x40</td><td>2023-03-21</td></tr><tr><td>Java21</td><td>65</td><td>0x41</td><td>2023-09-19</td></tr><tr><td>Java22</td><td>66</td><td>0x42</td><td>2024-03-19</td></tr></tbody></table><h3 id="常量池" tabindex="-1"><a class="header-anchor" href="#常量池"><span>常量池</span></a></h3><p>常量池入口紧随主、次版本号之后，可以理解成Class文件的资源仓库。 与其他数据关联最多，占用空间最大，也是第一个出现的表类型数据项<code>cp_info</code>。</p><p><strong>1、常量池计数</strong></p><p>由于常量项不固定，入口处<code>u2</code>类型的数据值表示<strong>常量池计数</strong>（<code>constant_pool_count</code>）。</p><ul><li>常量池的计数从1开始，即：<code>常量项 = 常量池计数 - 1</code></li><li>Class文件格式规范刻意将第0项常量空出，索引值0表示“不引用任何常量池项”</li></ul><p><strong>2、常量类型</strong></p><p>常量池主要存放两大类常量：字面量（Literal）和符号引用（Symbolic References）</p><ul><li><strong>字面量：</strong> 比较接近于Java语言层面的常量概念，如数值、文本字符串、final常量等</li><li><strong>符号引用：</strong> 符号引用则属于编译原理方面的概念，包括以下几类常量： <ul><li>被模块导出或者开放的包(Package)</li><li>类和接口的全限定名(Fully Qualified Name)</li><li>字段的名称和描述符(Descriptor)</li><li>方法的名称和描述符</li><li>方法句柄和方法类型(Method Handle、Method Type、Invoke Dynamic)</li><li>动态调用点和动态常量(Dynamically-Computed Call Site、Dynamically-Computed Constant)</li></ul></li></ul><p>不同于C/C++编译时有“连接”步骤，JVM在加载Class文件时才进行“动态连接”。 因此，Class文件不保存方法、字段最终在内存中的布局信息。 JVM在类加载时从常量池获取符号引用，并在类创建或运行时解析为具体地址。</p><p><strong>3、常量表结构</strong></p>`,23),h={href:"https://docs.oracle.com/javase/specs/jvms/se22/html/jvms-4.html#jvms-4.4",target:"_blank",rel:"noopener noreferrer"},v=a("code",null,"constant_pool",-1),g=n(`<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>cp_info <span class="token punctuation">{</span>
  u1 tag<span class="token punctuation">;</span>
  u1 info<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>常量池中的每项常量都是一个表，起始的第一位是一个<code>u1</code>类型的标志位（tag），表示当前常量的类型。</p><ol><li>最初设计的11种常量类型</li><li>为支持动态语言，增加了4种动态语言相关的常量</li><li>为支持Java模块化系统（Jigsaw），新增了<code>CONSTANT_Module_info</code>和<code>CONSTANT_Package_info</code></li></ol><table><thead><tr><th>类型</th><th>标志（tag）</th><th>描述</th></tr></thead><tbody><tr><td>CONSTANT_Utf8_info</td><td>1</td><td>UTF-8编码的字符串</td></tr><tr><td>CONSTANT_Integer_info</td><td>3</td><td>整型字面量</td></tr><tr><td>CONSTANT_Float_info</td><td>4</td><td>浮点型字面量</td></tr><tr><td>CONSTANT_Long_info</td><td>5</td><td>长整型字面量</td></tr><tr><td>CONSTANT_Double_info</td><td>6</td><td>双精度浮点型字面量</td></tr><tr><td>CONSTANT_Class_info</td><td>7</td><td>类或接口的符号引用</td></tr><tr><td>CONSTANT_String_info</td><td>8</td><td>字符串类型字面量</td></tr><tr><td>CONSTANT_Fieldref_info</td><td>9</td><td>字段的符号引用</td></tr><tr><td>CONSTANT_Methodref_info</td><td>10</td><td>类中方法的符号引用</td></tr><tr><td>CONSTANT_InterfaceMethodref_info</td><td>11</td><td>接口中方法的符号引用</td></tr><tr><td>CONSTANT_NameAndType_info</td><td>12</td><td>字段或方法的部分符号引用</td></tr><tr><td>CONSTANT_MethodHandle_info</td><td>15</td><td>表示方法句柄</td></tr><tr><td>CONSTANT_MethodType_info</td><td>16</td><td>表示方法类型</td></tr><tr><td>CONSTANT_Dynamic_info</td><td>17</td><td>表示一个动态计算常量</td></tr><tr><td>CONSTANT_InvokeDynamic_info</td><td>18</td><td>表示一个动态方法调用点</td></tr><tr><td>CONSTANT_Module_info</td><td>19</td><td>表示一个模块</td></tr><tr><td>CONSTANT_Package_info</td><td>20</td><td>表示一个模块中开放或者导出的包</td></tr></tbody></table><h3 id="访问标志" tabindex="-1"><a class="header-anchor" href="#访问标志"><span>访问标志</span></a></h3><h3 id="类索引、父类索引与接口索引集合" tabindex="-1"><a class="header-anchor" href="#类索引、父类索引与接口索引集合"><span>类索引、父类索引与接口索引集合</span></a></h3><h3 id="字段表集合" tabindex="-1"><a class="header-anchor" href="#字段表集合"><span>字段表集合</span></a></h3><h3 id="方法表集合" tabindex="-1"><a class="header-anchor" href="#方法表集合"><span>方法表集合</span></a></h3><h3 id="属性表集合" tabindex="-1"><a class="header-anchor" href="#属性表集合"><span>属性表集合</span></a></h3>`,9);function _(k,f){const s=o("ExternalLinkIcon");return l(),i("div",null,[r,a("p",null,[a("a",p,[t("JVM虚拟机规范第四章"),e(s)]),t(" 中规定了Class文件必须是一个固定的"),u,t("结构，如下所示：")]),m,a("p",null,[a("a",h,[t("JVM虚拟机规范第四章-常量池"),e(s)]),t(" 定义了"),v,t("表条目具有以下通用格式：")]),g])}const C=d(c,[["render",_],["__file","class.html.vue"]]),T=JSON.parse('{"path":"/md/jvm/basics/class.html","title":"类字节码详解","lang":"zh-CN","frontmatter":{"title":"类字节码详解","description":"类字节码详解 计算机只能运行由0和1构成的二进制格式。 要运行Java程序，必须先通过Java虚拟机（JVM）执行编译后的Java代码，这个编译后的代码就是Java字节码。 跨平台的基石 Java字节码具有“平台无关性”和“语言无关性”。 平台无关性： 字节码可以在任何支持JVM的平台上运行，实现“一次编写，到处运行” 语言无关性： 多种编程语言可以编...","author":"会敲代码的程序猿","isOriginal":true,"date":"2024-07-19T00:00:00.000Z","category":"JVM","tag":"JVM","order":2,"head":[["meta",{"property":"og:url","content":"https://www.geekyspace.cn/md/jvm/basics/class.html"}],["meta",{"property":"og:title","content":"类字节码详解"}],["meta",{"property":"og:description","content":"类字节码详解 计算机只能运行由0和1构成的二进制格式。 要运行Java程序，必须先通过Java虚拟机（JVM）执行编译后的Java代码，这个编译后的代码就是Java字节码。 跨平台的基石 Java字节码具有“平台无关性”和“语言无关性”。 平台无关性： 字节码可以在任何支持JVM的平台上运行，实现“一次编写，到处运行” 语言无关性： 多种编程语言可以编..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://img.geekyspace.cn/pictures/2024/202407200209120.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-07-22T19:21:43.000Z"}],["meta",{"property":"article:author","content":"会敲代码的程序猿"}],["meta",{"property":"article:tag","content":"JVM"}],["meta",{"property":"article:published_time","content":"2024-07-19T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-07-22T19:21:43.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"类字节码详解\\",\\"image\\":[\\"https://img.geekyspace.cn/pictures/2024/202407200209120.png\\",\\"https://img.geekyspace.cn/pictures/2024/202407220149546.png\\"],\\"datePublished\\":\\"2024-07-19T00:00:00.000Z\\",\\"dateModified\\":\\"2024-07-22T19:21:43.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"会敲代码的程序猿\\"}]}"]]},"headers":[{"level":2,"title":"跨平台的基石","slug":"跨平台的基石","link":"#跨平台的基石","children":[]},{"level":2,"title":"Class类文件结构","slug":"class类文件结构","link":"#class类文件结构","children":[{"level":3,"title":"魔数","slug":"魔数","link":"#魔数","children":[]},{"level":3,"title":"Class文件版本号","slug":"class文件版本号","link":"#class文件版本号","children":[]},{"level":3,"title":"常量池","slug":"常量池","link":"#常量池","children":[]},{"level":3,"title":"访问标志","slug":"访问标志","link":"#访问标志","children":[]},{"level":3,"title":"类索引、父类索引与接口索引集合","slug":"类索引、父类索引与接口索引集合","link":"#类索引、父类索引与接口索引集合","children":[]},{"level":3,"title":"字段表集合","slug":"字段表集合","link":"#字段表集合","children":[]},{"level":3,"title":"方法表集合","slug":"方法表集合","link":"#方法表集合","children":[]},{"level":3,"title":"属性表集合","slug":"属性表集合","link":"#属性表集合","children":[]}]}],"git":{"createdTime":1721457632000,"updatedTime":1721676103000,"contributors":[{"name":"joeljhou","email":"joeljhou336@gmail.com","commits":5}]},"readingTime":{"minutes":5.92,"words":1776},"filePathRelative":"md/jvm/basics/class.md","localizedDate":"2024年7月19日","excerpt":"\\n<blockquote>\\n<p>计算机只能运行由0和1构成的二进制格式。\\n要运行Java程序，必须先通过Java虚拟机（JVM）执行编译后的Java代码，这个编译后的代码就是<strong>Java字节码</strong>。</p>\\n</blockquote>\\n<h2>跨平台的基石</h2>\\n<p>Java字节码具有“平台无关性”和“语言无关性”。</p>\\n<ul>\\n<li><strong>平台无关性：</strong> 字节码可以在任何支持JVM的平台上运行，实现“一次编写，到处运行”</li>\\n<li><strong>语言无关性：</strong> 多种编程语言可以编译成字节码并在JVM（GraalVM）上运行，不仅限于Java</li>\\n</ul>","copyright":{"author":"会敲代码的程序猿"},"autoDesc":true}');export{C as comp,T as data};
